---
title: "Stat 4121: Applied Spatial Statistics"
author: "Bedilu A. Ejigu"
date: "2025-09-10"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

```

# Overview of Datasets and Common R Packages used for the course

Make sure you properly set your working directory and create an R
project.

## Data management

Load general data management packages.

```{r}
#Installing  data management package 
  dm_package<- c("dplyr", "tidyr","tidyverse","DT")
  #install.packages(dm_package) 
#Load the required packages
   lapply(dm_package, library, character.only = TRUE) 
```

Install and Load spatial data reading and writing packages.

```{r}
# Spatial data reading and  writing packages
spdata_package<- c("sp", "sf","terra",  "raster","stars","rgdal")
  #install.packages(spdata_package) 
# Load the required packages
    lapply(spdata_package, library, character.only = TRUE) 
```

Packages to access geospatial data sources.

```{r}
# Spatial data reading and  writing packages
spdata2_package <- c("geodata","rnaturalearth","elevatr","tigris","rgbif","geonames", "osmdata", "osmapiR","rgeoboundaries")
  install.packages(spdata2_package) 
# Load the required packages
  lapply(spdata2_package, library, character.only = TRUE) 
```

## Visulaization/ mapping

One of the typical feature of "R" which are not available in other
software's are its capability in graphics and mapping. R can generate
both static and interactive maps. Some packages (i.e., ggplot2, tmap)
generate both statistic and interactive maps. Some only generate
interactive maps (i.e., leaflet).

### Static graphics

Install and load data visualization/mapping and coloring packages.

```{r}
# Installing packages, visualization/mapping package 
  map_static<- c("RColorBrewer", "viridis", "cartography", "ggmap","tmap","ggmap","mapsf", "ggthemes")
   #install.packages(map_static) 
#Load the required packages
   lapply(map_static, library, character.only = TRUE) 
```

### Intractive mapping

Installing and loading interactive mapping packages.

```{r}
# Installing packages, visualization/mapping package 
map_interactive<- c("mapview","leaflet")
    #install.packages(map_interactive) 
#Load the required packages
  lapply(map_interactive, library, character.only = TRUE) 
```

## Modeling

There are a number of R-packages developed to model spatial data.
Herewith below a list of selected spatial data modeling packages.

```{r}
# Geostatistical data 
     #model_geostat<- c("PrevMap","geoR","car","gstat")
     #install.packages(model_geostat) 
     #lapply(model_geostat, library, character.only = TRUE)

# Areal data modeling
     #model_geostat<- c("spmodel","spatialreg","spdep")
     #install.packages(model_geostat) 
     #lapply(model_geostat, library, character.only = TRUE)

# Point pattern data
    #model_point<- c("stppSim","spatstat")
    #install.packages(model_point) 
    #lapply(model_point, library, character.only = TRUE)

# Bayesian 

    #Install INLA
#install.packages("INLA",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/testing"), dep=TRUE)
   # Other Bayesian
   #model_bayesian<- c("spBasye", "INLAspacetime","BayesSurvival")
   #install.packages(model_bayesian) 
   #lapply(model_bayesian, library, character.only = TRUE)
```

# Package Manager

You can simultaneously load multiple packages using *p_load* function
from the R package manager **pacman** package.

```{r}
#Load required packages
require(pacman) # Package manager for  R
#Simultaneously load installed packages
p_load(dyplr,tidyr,tidyverse,DT, sf,sp,terra,raster ,stars,rgdal,geodata, rnaturalearth,rgeoboundaries, elevatr, tigris,rgbif, geonames, osmdata, osmapiR, cartography, RColorBrewer, viridis , ggmap,ggthemes,mapview,leaflet,tmap, ggplot2, mapsf, car,gstat, spmodel,spatialreg,spdep,geoR,PrevMap, INLA)
```

# Datasets for the Course

## Survey Datasets

### Malnutrition in Ethiopia (EDHS2016)

Nutritional insufficiency, is a major health problem among U5 children.
Chronic stunting accounts for various health problems and leading to
different diseases later in adolescents and adults. Prevalence of
stunting for U5 children in Ethiopia was 38.7% (EDHS 2016). Based on WHO
guideline, a child is stunted when a height for age Z-score (HAZ) is \<
$-2SD$. This dataset was extracted from the [Demographic and Health
Survey]{<https://dhsprogram.com/>} 2016 conducted in Ethiopia. The
variable names found in the dataset with their label are the following.

![Table 1: Malnutrition data description](stunting.png) This dataset
used to demonstrate data exploration and modeling techniques under
spatial and non-spatial setting. To demonstrate the advantage of spatial
models over the standard linear model, this dataset further explored in
Chapter XX. The data contain information on the height-for-age score
(HAZ) of `r nrow(read.csv("Stunting2.csv"))` children. HAZ is an
age-standardized measure of the deviation from standard child growth.
Values of HAZ close to zero indicate normal growth, whilst values less
than −2 are interpreted as an indication of stunted growth. Before doing
further analysis, it is common to examine the structure and different
figures of the data under consideration. Table \@ref(tab:data-layout)
and Figure \@ref(fig:HAZ-EDA) helps to uncover the some features of the
data. Table \@ref(tab:data-layout) presents the layout of the data under
consideration.

```{r data-layout,eval=TRUE, include=TRUE, eco=TRUE}
maln <- read.csv("Data/Stunting2.csv")
library(kableExtra)
library(tidyverse)
kable(sample_n(maln[,c(1,2,3,4,5,6,7,14,8,11,9,10)], 10),
rownames = FALSE, options = list(pageLength = 10), caption = " Sample malnutrition data layout extracted from 2016 EDHS" ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 10), full_width = F, position = "center")
```

Figure \@ref(fig:HAZ-EDA) presents the survey locations (top left
panel), and the relationship between HAZ with other covariates (Age,
mother educational level and household wealth index).

```{r HAZ-EDA, eval=TRUE, echo=TRUE, fig.cap="Plots for malnutrition data in Ethiopia: (a) point-map showing the sampled clusters; (b) scatter plot of HAZ against child age; (c) box-plots of HAZ by child mother level of education; (d) box-plots of HAZ by place of residence",include=TRUE,out.width = '80%',fig.pos='center'}

maln <- read.csv("Data/Stunting2.csv")
Eth.bndrs<-read.csv("Data/Eth_bndrs.csv")
par(mfrow=c(2,2),mar=c(4,4,2,2))
coords <- unique(maln[,c("utm_x","utm_y")])
plot(Eth.bndrs,type="l",asp =1,xlab="",ylab="", main=c("(a)"))
points(coords,pch=20,cex=0.5)
plot(maln$age,maln$haz, main="(b)",xlab="Child Age", ylab=" HAZ Score",abline(lm(haz ~ age, data = maln), col = "red",lwd=3))
plot(haz ~ factor(meducation), data = maln, main=c("(c)"), xlab="Mothers education level")
plot(haz ~ factor(residence), data = maln, main=c("(d)"), xlab="Place of residence")
```

**Further Data Exploration**

The analyst may also interested to explore frequency distribution and
proportions for selected variable as presented below.

```{r stun-eduTab, include=TRUE,eval=TRUE,echo=TRUE}
maln <- read.csv("Data/Stunting2.csv")
library(sjPlot)
# Exploratory Data summerization
# Cross-tabs
sjt.xtab(maln$stunted, #rows
         maln$education, #columns
         title ="Stunting by child mother educational level",
        show.cell.prc = FALSE,
        show.row.prc = FALSE,
        show.col.prc = TRUE,
        show.summary = TRUE,
        drop.empty = TRUE,
  statistics = c("auto", "cramer", "phi", "spearman", "kendall", "pearson", "fisher"), file ="sjt_contingency.doc")

# Correlation
tab_corr(maln[,c(11,14)], corr.method="pearson",na.deletion ="pairwise", title ="Pearson correlation between WAZ and Age")
```

A set of different plotting and table output functions for data
visualization can be simultansouly obtained from **strengejacke**
package, which can be easily installed from GitHub.

```{r echo=TRUE,include=TRUE,eval=FALSE}
devtools::install_github("strengejacke/strengejacke")
```

The analysit may also interested to explore frequency distribution and
proportions for selected varible as presented below. The *CrossTable()*
command from the **gmodels** package produces frequencies, and table,
row, and column proportions with a single command.

```{r eval=TRUE, include=TRUE,echo=TRUE}
table(maln$education)
library(gmodels)
CrossTable(maln$wealth, maln$stunted)
```

**The *stargazer* Package**

```{r,eval=TRUE,include=TRUE,echo=TRUE}
maln <- read.csv("Data/Stunting2.csv")
library(stargazer)
# Numerical data Summary
stargazer(maln[,c(11,14)],
digits=2,
type="text", #other options:latex,html
title="Descriptive Statistics",
out="star_descriptive_2.doc")
```

### Categorical Data Exploration

```{r eval=TRUE,include=TRUE,echo=TRUE}
library(dplyr)
library(tidyr)
library(knitr)
# Crosstab/contingency table
maln%>%group_by(wealth,stunted)%>%
  summarise(n=n())%>%
  spread(stunted, n)%>%
  kable()
# Proportion
maln%>%group_by(wealth, stunted)%>%
  summarize(n=n())%>%
  mutate(prop=n/sum(n))%>%
 subset(select=c("wealth","stunted","prop"))%>% #drop the frequency value
  spread(wealth, prop)%>%
  kable()
```

### Child-grwoth in Africa

Here,we consider data from 174,281 children under the age of 5 from 30
Sub-Saharan Africa countries. We identified the most recent Demographic
and Health Surveys conducted from 2010 to 2022 and downloaded from the
[DHS website](http://dhsprogram.com) after being granted permission. The
Child’s Recode (KR File) dataset from each country was imported into
Stata18.0 (Stata Corp, 2023) and pooled for further analysis. Further
details on the DHS survey implementation and study design are described
elsewhere (Corsi, 2016).

The main outcome variables are: i) Wasting (weight-for-height, WHZ\<-2),
ii) Stunting (height-for-age, HAZ \<-2), iii) Underweight
(weight-for-age, WAZ \<-2), and iv) Co-existence of wasting, stunting
and underweight.

```{r child-data,eval=TRUE, include=TRUE, eco=TRUE,message=FALSE}
mal <- read.csv("Data/ChildGrowth.csv")
library(kableExtra)
library(tidyverse)
kable(sample_n(mal[ ,c(1:10)], 10), caption = " Random sample data layout extracted from summarized child grwoth data") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", font_size=10), full_width = T, position = "center")
```

### HIV in South AFrica

HIV/AIDS continues to be a significant global health concern, and
HIV/AIDS perspective in South Africa reveals a unique set of challenges
shaped by historical context and sociopolitical dynamics. South Africa
is home to one of the highest numbers of people living with HIV
globally; thus, it faces enormous pressure in responding effectively. To
avoid, delayed intervention, the South Africa National HIV Prevalence,
Incidence, Behavior and Communication Survey (SABSSM) and antenatal HIV
sentinel survey conducted yearly and bi-annually, respectively. For
demonstration purpose, here we consider the 2022 antenatal HIV sentinel
survey.

```{r HIV-data,eval=TRUE, include=TRUE, eco=TRUE,message=FALSE}
library(kableExtra)
library(tidyverse)
#Load district level summarized HIV data
HIV_prev <- read.csv("Data/SA_Admn2_HIV.csv")

kable(sample_n(HIV_prev[ ,c(1:10)], 10), caption = "Random sample data layout extracted from distirect level summarized data") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", font_size=10), full_width = T, position = "center")

```

# Spatial Data Types

Spatial data exploration depends on the type of spatial data under
investigation.

## Areal/lattice type of spatial data

Areal or lattice type of data analysis begin by considering the spatial
dependence which is handled through a weighting/neighborhood matrix. The
**spdep** and **genstat** packages in **R** contains a number of
functions to deal with spatial dependence structures for areal or
lattice type of data. Some of its functions can be used to construct
spatial neighborhood matrices and perform spatial autocorrelation
analyses. For example, the functions *poly2nb()* and *dnearneigh()* can
be used to create neighbor lists based on contiguity and distance
criteria, respectively. Spatial neighborhood matrices can be built from
the neighbor lists using the *nb2listw()* function.

### Data prepartion

First load the dataset with polygon shapefile and collected observations
in each polygon. To demonstrate basic concepts, PMA2019 survey data was
considered. In this survey data from 13 Zones (from SNNP and Somali
regions) were not collected. As a result region average values were
imputed for each of the 13 zones(SNNP-Amaro, SNNP-Basketo, SNNP-Burji,
Somali-Daawa, SNNP-Derashe, Somali-Doolo,
SNNP-Halaba,SNNP-Konta,Somali-Korahe,SNNP-Mirab
Omo,Somali-Nogob,Somali-Shabelle,SNNP-Yem).

```{r}
library(sf)
library(spdep)
# Load ETH shapefile
 #Eth_region=st_read("Shapefiles/ETH_adm/ETH_adm1.shp")
#plot(Eth_region$geometry)
# Load Ethiopia  Zone shape files
ETH.Zone=st_read("Data/Shapefiles/ETH2021/eth_admbnda_adm2_csa_bofedb_2021.shp") #
plot(ETH.Zone$geometry)
```

```{r}
# Load the survey summary data aggregated by Zone
mcp_data=read.csv("Data/mCP2019.csv")
# Add Average distance to the SDP  into the  Zone shapefile data
ETH.Zone$mcp=c(mcp_data$mcp)
ETH.Zone$mean_dist=c(mcp_data$mean)
ETHzone_mcp=ETH.Zone[,c(1,2,3,8,15,16,17)]
View(ETHzone_mcp)
```

## Spatial Datasets within R-Packages

### North Carolina SIDS data- from the SpData Package

The North Carolina sudden infant death syndrome (SIDS) data was first
presented by Atkinson (1978) and in later stages this additional
variables augmented to this dataset by different scholars. It contained
the annual number of SIDS and death rate per 1000 live births by county
and year.

Brief summary of the data:

-   SIDS incidence
-   collected over 2 time intervals:
    -   aggregated from 1974 to 1978; and
    -   aggregated from 1979 to 1984
-   100 areas (counties in North Carolina, United States)

```{r}
library(sf) # To handle shape files
library(spDataLarge) # To access the SIDS dataset
nc.sids <- read_sf(system.file("shapes/sids.shp", package = "spData"))
head(nc.sids)
plot(nc.sids$geometry)
```

```{r}
library(sf)
# Load the NC shapefile that ships with {sf}
nc <- st_read(system.file("shape/nc.shp", package = "sf"), quiet = TRUE)
head(nc)
plot(nc["SID74"])  # or: plot(st_geometry(nc))

```

# Spatial Data Formats

Coordinate Reference System (CRS) of spatial objects defines where they
are placed on the Earth's surface. CRS of spatial objects defines where
they are placed on the Earth's surface and location on earth can be
referenced in two ways.

1)  Geographical or unprojected CRS
2)  Projected CRS

![Figure 2: Geograpical (unprojected, left panel) and projected CRS
(reghit panel)](CRS2.png)

Both raster and vector data formats are two very different but common
forms of spatial data used to **store geospatial data**.

**Vector data**

Shapefiles (spatial Vector data format) are data storage formats often
used to represents vector data. Such data storage format represented as
either points, lines, or polygons. Shapefiles are not single files,
rather a collection of at least three mandatory files.

-   **.shp** which contains the geometry data,
-   **.shx** which is a positional index of the geometry data that
    allows to seek forward and backward the .shp file, and
-   \*\*.dbf\* which stores the attributes for each shape.

In addition to these three mandatory files, shapefile may include
**.prj** which is a plain text file describing the projection, **.sbn**
and **.sbx** which are spatial indices of the geometry data, and
**.shp.xml** which contains spatial metadata in XML format. Thus, when
you are working with a *shapefile*, it is important to obtain all files
that compose the shapefile and not only the *.shp* file with the
geometry data.

**Example:** Load Ethiopian administartive boundary shapefile and
explore the data.

**Raster/gird data**

Raster data (also referred to as grid data) is a spatial data storage
format that divides the region of study into rectangles of the same size
called cells or pixels, and that can store one or more values for each
of these cells. Raster data is used to represent spatially continuous
phenomena, such as elevation, temperature, altitude or air pollution
values.

Such data format are used to store aerial photography and satellite
imagery, where each image consists of multiple pixels and their
associated values. Locations are stored as pixels (implies require more
storage than vector data)

**Example**

Raster data often come in \*GeoTIFF\*\* format which has extension
*.tif*. To see how the elevation in Luxembourg, let us use the
*terra::rast()* function to read the *elev.tif* file of the terra
package and plot it as follows.

```{r}
library(terra)
pathraster <- system.file("ex/elev.tif", package = "terra")
r <- terra::rast(pathraster)
r
plot(r)
```

**Exercise**

Get the population density of Ethiopia from [The Humanitarian Data
Exchange](https://data.humdata.org/) website, and navigate the raster
data graphically. Further, explore what type of spatial datasets are
available in this website.

# Spatial Data Visulization

**Example 1**: Malnutrition in Africa

```{r}
library(rnaturalearth)
library(sf)
map <- ne_countries(continent = "africa")
plot(map$geometry)
# Loading the data and merging with the shapefile
d=read.csv("Data/Africa_Nutrition.csv")
names(d)
map$underweight=d$Under.weight
map$Normal=d$Normal.Weight
map$Overweight=d$Over.weight
map$Obese=d$Obese
# Mapping malnutirion by country
library(ggplot2)
library(viridis)
ggplot(data=map,aes(fill=Obese)) + geom_sf() +scale_fill_viridis() + theme_bw()
  ggsave("Obese.pdf")
  ggsave("Obese.png",width=6,height=9,dpi="screen")
```

```{r}
# First get centroid coordinates
region_point=cbind(map,st_coordinates(st_centroid(map$geometry)))

ggplot(data=region_point,aes(fill=Obese)) + geom_sf() +scale_fill_viridis() + theme_bw() +  geom_text(aes(X, Y, label=Region), color = "black", size=3)
```

## Mapping Ethiopia by Region

```{r}
library(sf)
library(ggplot2)
# Loading district shapefile
Region=st_read("Data/ShapeFiles/Ethadmin2023/Ethadmin1_23/ET_Admin1_2023.shp") # 14  region
View(Region)
Zone=st_read("Data/ShapeFiles/Ethadmin2023/Ethadmin2_23/ET_Admin2_2023.shp") 
Woreda=st_read("Data/ShapeFiles/Ethadmin2023/Ethadmin3_2023/ET_Admin3_2023.shp") 

```

```{r mapping}
#Region
plot(Zone$geometry)
```

### Spatial Data Visulization: Malnutrition in Africa

```{r}
library(rnaturalearth)
library(sf)
map <- ne_countries(continent = "africa")
plot(map$geometry)

# Loading the data and merging with the shapefile
d=read.csv("Data/Africa_Nutrition.csv")
names(d)
map$underweight=d$Under.weight
map$Normal=d$Normal.Weight
map$Overweight=d$Over.weight
map$Obese=d$Obese
# Mapping malnutirion by country
library(ggplot2)
library(viridis)
ggplot(data=map,aes(fill=Obese)) + geom_sf() +scale_fill_viridis() + theme_bw()
  ggsave("Obese.pdf")
  ggsave("Obese.png",width=6,height=9,dpi="screen")
```
